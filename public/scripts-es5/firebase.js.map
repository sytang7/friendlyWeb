{"version":3,"sources":["../scripts/firebase.js"],"names":["window","friendlyPix","Firebase","database","firebase","storage","auth","firebaseRefs","forEach","ref","off","postId","callback","latestCommentId","_subscribeToFeed","_getPaginatedFeed","COMMENTS_PAGE_SIZE","latestPostId","POSTS_PAGE_SIZE","currentUser","uid","USER_PAGE_POSTS_PAGE_SIZE","uri","latestEntryId","fetchPostDetails","feedRef","orderByKey","startAt","on","feedData","key","val","once","then","postData","push","pageSize","earliestEntryId","console","log","endAt","limitToLast","entries","data","nextPage","entryIds","Object","keys","length","nextPageStartingId","shift","queries","map","getPostData","Promise","all","deleteOps","results","result","deleteFromFeed","followingRef","followedUid","followingData","followedUserPostsRef","String","updates","update","followedUserId","following","updateOperations","lastSyncedPostId","searchString","maxResults","latinize","toLowerCase","query","orderByChild","limitToFirst","reversedQuery","people","userIds","name","userId","_search_index","full_name","reversedName","reversed_full_name","startsWith","imageUrl","displayName","searchFullName","searchReversedFullName","split","reverse","join","e","error","updateData","profile_picture","likesRef","value","set","ServerValue","TIMESTAMP","commentText","commentObject","text","timestamp","Date","now","author","photoURL","pic","thumb","fileName","newPostKey","picRef","metadata","contentType","type","picUploadTask","put","snapshot","totalBytes","url","downloadURLs","catch","thumbRef","tumbUploadTask","full_url","urls","thumb_url","full_storage_uri","toString","thumb_storage_uri","follow","lastPostId","post","followStatusRef","checked","token","likesCallback","numChildren","commentsCallback","commentsRef","followersCallback","followersRef","followingCallback","followingUids","fetchProfileDetailsOperations","loadUserProfile","followingUid","profiles","postsCallback","userPostsRef","picStorageUri","thumbStorageUri","updateObj","deleteFromDatabase","deletePicFromStorage","refFromURL","delete","deleteThumbFromStorage","remove","deletionCallback","postsRef"],"mappings":"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","file":"firebase.js","sourcesContent":["/**\n * Copyright 2015 Google Inc. All Rights Reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n'use strict';\n\nwindow.friendlyPix = window.friendlyPix || {};\n\n/**\n * Handles all Firebase interactions.\n */\nfriendlyPix.Firebase = class {\n  /**\n   * Number of posts loaded initially and per page for the feeds.\n   * @return {number}\n   */\n  static get POSTS_PAGE_SIZE() {\n    return 5;\n  }\n\n  /**\n   * Number of posts loaded initially and per page for the User Profile page.\n   * @return {number}\n   */\n  static get USER_PAGE_POSTS_PAGE_SIZE() {\n    return 6;\n  }\n\n  /**\n   * Number of posts comments loaded initially and per page.\n   * @return {number}\n   */\n  static get COMMENTS_PAGE_SIZE() {\n    return 3;\n  }\n\n  /**\n   * Initializes this Firebase facade.\n   * @constructor\n   */\n  constructor() {\n    // Firebase SDK.\n    this.database = firebase.database();\n    this.storage = firebase.storage();\n    this.auth = firebase.auth();\n\n    // Firebase references that are listened to.\n    this.firebaseRefs = [];\n  }\n\n  /**\n   * Turns off all Firebase listeners.\n   */\n  cancelAllSubscriptions() {\n    this.firebaseRefs.forEach(ref => ref.off());\n    this.firebaseRefs = [];\n  }\n\n  /**\n   * Subscribes to receive updates from a post's comments. The given `callback` function gets\n   * called for each new comment to the post with ID `postId`.\n   *\n   * If provided we'll only listen to comments that were posted after `latestCommentId`.\n   */\n  subscribeToComments(postId, callback, latestCommentId) {\n    return this._subscribeToFeed(`/comments/${postId}`, callback, latestCommentId, false);\n  }\n\n  /**\n   * Paginates comments from the post with ID `postId`.\n   *\n   * Fetches a page of `COMMENTS_PAGE_SIZE` comments from the post.\n   *\n   * We return a `Promise` which resolves with an Map of comments and a function to the next page or\n   * `null` if there is no next page.\n   */\n  getComments(postId) {\n    return this._getPaginatedFeed(`/comments/${postId}`,\n        friendlyPix.Firebase.COMMENTS_PAGE_SIZE, null, false);\n  }\n\n  /**\n   * Subscribes to receive updates to the general posts feed. The given `callback` function gets\n   * called for each new post to the general post feed.\n   *\n   * If provided we'll only listen to posts that were posted after `latestPostId`.\n   */\n  subscribeToGeneralFeed(callback, latestPostId) {\n    return this._subscribeToFeed('/posts/', callback, latestPostId);\n  }\n\n  /**\n   * Paginates posts from the global post feed.\n   *\n   * Fetches a page of `POSTS_PAGE_SIZE` posts from the global feed.\n   *\n   * We return a `Promise` which resolves with an Map of posts and a function to the next page or\n   * `null` if there is no next page.\n   */\n  getPosts() {\n    return this._getPaginatedFeed('/posts/', friendlyPix.Firebase.POSTS_PAGE_SIZE);\n  }\n\n  /**\n   * Subscribes to receive updates to the home feed. The given `callback` function gets called for\n   * each new post to the general post feed.\n   *\n   * If provided we'll only listen to posts that were posted after `latestPostId`.\n   */\n  subscribeToHomeFeed(callback, latestPostId) {\n    return this._subscribeToFeed(`/feed/${this.auth.currentUser.uid}`, callback, latestPostId,\n        true);\n  }\n\n  /**\n   * Paginates posts from the user's home feed.\n   *\n   * Fetches a page of `POSTS_PAGE_SIZE` posts from the user's home feed.\n   *\n   * We return a `Promise` which resolves with an Map of posts and a function to the next page or\n   * `null` if there is no next page.\n   */\n  getHomeFeedPosts() {\n    return this._getPaginatedFeed(`/feed/${this.auth.currentUser.uid}`,\n        friendlyPix.Firebase.POSTS_PAGE_SIZE, null, true);\n  }\n\n  /**\n   * Subscribes to receive updates to the home feed. The given `callback` function gets called for\n   * each new post to the general post feed.\n   *\n   * If provided we'll only listen to posts that were posted after `latestPostId`.\n   */\n  subscribeToUserFeed(uid, callback, latestPostId) {\n    return this._subscribeToFeed(`/people/${uid}/posts`, callback,\n        latestPostId, true);\n  }\n\n  /**\n   * Paginates posts from the user's posts feed.\n   *\n   * Fetches a page of `USER_PAGE_POSTS_PAGE_SIZE` posts from the user's posts feed.\n   *\n   * We return a `Promise` which resolves with an Map of posts and a function to the next page or\n   * `null` if there is no next page.\n   */\n  getUserFeedPosts(uid) {\n    return this._getPaginatedFeed(`/people/${uid}/posts`,\n        friendlyPix.Firebase.USER_PAGE_POSTS_PAGE_SIZE, null, true);\n  }\n\n  /**\n   * Subscribes to receive updates to the given feed. The given `callback` function gets called\n   * for each new entry on the given feed.\n   *\n   * If provided we'll only listen to entries that were posted after `latestEntryId`. This allows to\n   * listen only for new feed entries after fetching existing entries using `_getPaginatedFeed()`.\n   *\n   * If needed the posts details can be fetched. This is useful for shallow post feeds.\n   * @private\n   */\n  _subscribeToFeed(uri, callback, latestEntryId = null, fetchPostDetails = false) {\n    // Load all posts information.\n    let feedRef = this.database.ref(uri);\n    if (latestEntryId) {\n      feedRef = feedRef.orderByKey().startAt(latestEntryId);\n    }\n    feedRef.on('child_added', feedData => {\n      if (feedData.key !== latestEntryId) {\n        if (!fetchPostDetails) {\n          callback(feedData.key, feedData.val());\n        } else {\n          this.database.ref(`/posts/${feedData.key}`).once('value').then(\n              postData => callback(postData.key, postData.val()));\n        }\n      }\n    });\n    this.firebaseRefs.push(feedRef);\n  }\n\n  /**\n   * Paginates entries from the given feed.\n   *\n   * Fetches a page of `pageSize` entries from the given feed.\n   *\n   * If provided we'll return entries that were posted before (and including) `earliestEntryId`.\n   *\n   * We return a `Promise` which resolves with an Map of entries and a function to the next page or\n   * `null` if there is no next page.\n   *\n   * If needed the posts details can be fetched. This is useful for shallow post feeds like the user\n   * home feed and the user post feed.\n   * @private\n   */\n  _getPaginatedFeed(uri, pageSize, earliestEntryId = null, fetchPostDetails = false) {\n    console.log('Fetching entries from', uri, 'start at', earliestEntryId, 'page size', pageSize);\n    let ref = this.database.ref(uri);\n    if (earliestEntryId) {\n      ref = ref.orderByKey().endAt(earliestEntryId);\n    }\n    // We're fetching an additional item as a cheap way to test if there is a next page.\n    return ref.limitToLast(pageSize + 1).once('value').then(data => {\n      const entries = data.val() || {};\n\n      // Figure out if there is a next page.\n      let nextPage = null;\n      const entryIds = Object.keys(entries);\n      if (entryIds.length > pageSize) {\n        delete entries[entryIds[0]];\n        const nextPageStartingId = entryIds.shift();\n        nextPage = () => this._getPaginatedFeed(\n            uri, pageSize, nextPageStartingId, fetchPostDetails);\n      }\n      if (fetchPostDetails) {\n        // Fetch details of all posts.\n        const queries = entryIds.map(postId => this.getPostData(postId));\n        // Since all the requests are being done one the same feed it's unlikely that a single one\n        // would fail and not the others so using Promise.all() is not so risky.\n        return Promise.all(queries).then(results => {\n          const deleteOps = [];\n          results.forEach(result => {\n            if (result.val()) {\n              entries[result.key] = result.val();\n            } else {\n              // We encountered a deleted post. Removing permanently from the feed.\n              delete entries[result.key];\n              deleteOps.push(this.deleteFromFeed(uri, result.key));\n            }\n          });\n          if (deleteOps.length > 0) {\n            // We had to remove some deleted posts from the feed. Lets run the query again to get\n            // the correct number of posts.\n            return this._getPaginatedFeed(uri, pageSize, earliestEntryId, fetchPostDetails);\n          }\n          return {entries: entries, nextPage: nextPage};\n        });\n      }\n      return {entries: entries, nextPage: nextPage};\n    });\n  }\n\n  /**\n   * Keeps the home feed populated with latest followed users' posts live.\n   */\n  startHomeFeedLiveUpdaters() {\n    // Make sure we listen on each followed people's posts.\n    const followingRef = this.database.ref(`/people/${this.auth.currentUser.uid}/following`);\n    this.firebaseRefs.push(followingRef);\n    followingRef.on('child_added', followingData => {\n      // Start listening the followed user's posts to populate the home feed.\n      const followedUid = followingData.key;\n      let followedUserPostsRef = this.database.ref(`/people/${followedUid}/posts`);\n      if (followingData.val() instanceof String) {\n        followedUserPostsRef = followedUserPostsRef.orderByKey().startAt(followingData.val());\n      }\n      this.firebaseRefs.push(followedUserPostsRef);\n      followedUserPostsRef.on('child_added', postData => {\n        if (postData.key !== followingData.val()) {\n          const updates = {};\n          updates[`/feed/${this.auth.currentUser.uid}/${postData.key}`] = true;\n          updates[`/people/${this.auth.currentUser.uid}/following/${followedUid}`] = postData.key;\n          this.database.ref().update(updates);\n        }\n      });\n    });\n    // Stop listening to users we unfollow.\n    followingRef.on('child_removed', followingData => {\n      // Stop listening the followed user's posts to populate the home feed.\n      const followedUserId = followingData.key;\n      this.database.ref(`/people/${followedUserId}/posts`).off();\n    });\n  }\n\n  /**\n   * Updates the home feed with new followed users' posts and returns a promise once that's done.\n   */\n  updateHomeFeeds() {\n    // Make sure we listen on each followed people's posts.\n    const followingRef = this.database.ref(`/people/${this.auth.currentUser.uid}/following`);\n    return followingRef.once('value', followingData => {\n      // Start listening the followed user's posts to populate the home feed.\n      const following = followingData.val();\n      if (!following) {\n        return;\n      }\n      const updateOperations = Object.keys(following).map(followedUid => {\n        let followedUserPostsRef = this.database.ref(`/people/${followedUid}/posts`);\n        const lastSyncedPostId = following[followedUid];\n        if (lastSyncedPostId instanceof String) {\n          followedUserPostsRef = followedUserPostsRef.orderByKey().startAt(lastSyncedPostId);\n        }\n        return followedUserPostsRef.once('value', postData => {\n          const updates = {};\n          if (!postData.val()) {\n            return;\n          }\n          Object.keys(postData.val()).forEach(postId => {\n            if (postId !== lastSyncedPostId) {\n              updates[`/feed/${this.auth.currentUser.uid}/${postId}`] = true;\n              updates[`/people/${this.auth.currentUser.uid}/following/${followedUid}`] = postId;\n            }\n          });\n          return this.database.ref().update(updates);\n        });\n      });\n      return Promise.all(updateOperations);\n    });\n  }\n\n  /**\n   * Returns the users which name match the given search query as a Promise.\n   */\n  searchUsers(searchString, maxResults) {\n    searchString = latinize(searchString).toLowerCase();\n    const query = this.database.ref('/people')\n        .orderByChild('_search_index/full_name').startAt(searchString)\n        .limitToFirst(maxResults).once('value');\n    const reversedQuery = this.database.ref('/people')\n        .orderByChild('_search_index/reversed_full_name').startAt(searchString)\n        .limitToFirst(maxResults).once('value');\n    return Promise.all([query, reversedQuery]).then(results => {\n      const people = {};\n      // construct people from the two search queries results.\n      results.forEach(result => result.forEach(data => {\n        people[data.key] = data.val();\n      }));\n\n      // Remove results that do not start with the search query.\n      const userIds = Object.keys(people);\n      userIds.forEach(userId => {\n        const name = people[userId]._search_index.full_name;\n        const reversedName = people[userId]._search_index.reversed_full_name;\n        if (!name.startsWith(searchString) && !reversedName.startsWith(searchString)) {\n          delete people[userId];\n        }\n      });\n      return people;\n    });\n  }\n\n  /**\n   * Saves or updates public user data in Firebase (such as image URL, display name...).\n   */\n  saveUserData(imageUrl, displayName) {\n    if (!displayName) {\n      displayName = 'Anonymous';\n    }\n    let searchFullName = displayName.toLowerCase();\n    let searchReversedFullName = searchFullName.split(' ').reverse().join(' ');\n    try {\n      searchFullName = latinize(searchFullName);\n      searchReversedFullName = latinize(searchReversedFullName);\n    } catch (e) {\n      console.error(e);\n    }\n\n    const updateData = {\n      profile_picture: imageUrl,\n      full_name: displayName,\n      _search_index: {\n        full_name: searchFullName,\n        reversed_full_name: searchReversedFullName\n      }\n    };\n    return this.database.ref(`people/${this.auth.currentUser.uid}`).update(updateData);\n  }\n\n  /**\n   * Fetches a single post data.\n   */\n  getPostData(postId) {\n    return this.database.ref(`/posts/${postId}`).once('value');\n  }\n\n  /**\n   * Subscribe to receive updates on a user's post like status.\n   */\n  registerToUserLike(postId, callback) {\n    // Load and listen to new Likes.\n    const likesRef = this.database.ref(`likes/${postId}/${this.auth.currentUser.uid}`);\n    likesRef.on('value', data => callback(!!data.val()));\n    this.firebaseRefs.push(likesRef);\n  }\n\n  /**\n   * Updates the like status of a post from the current user.\n   */\n  updateLike(postId, value) {\n    return this.database.ref(`likes/${postId}/${this.auth.currentUser.uid}`)\n        .set(value ? firebase.database.ServerValue.TIMESTAMP : null);\n  }\n\n  /**\n   * Adds a comment to a post.\n   */\n  addComment(postId, commentText) {\n    const commentObject = {\n      text: commentText,\n      timestamp: Date.now(),\n      author: {\n        uid: this.auth.currentUser.uid,\n        full_name: this.auth.currentUser.displayName,\n        profile_picture: this.auth.currentUser.photoURL\n      }\n    };\n    return this.database.ref(`comments/${postId}`).push(commentObject);\n  }\n\n  /**\n   * Uploads a new Picture to Cloud Storage and adds a new post referencing it.\n   * This returns a Promise which completes with the new Post ID.\n   */\n  uploadNewPic(pic, thumb, fileName, text) {\n    // Get a reference to where the post will be created.\n    const newPostKey = this.database.ref('/posts').push().key;\n\n    // Start the pic file upload to Cloud Storage.\n    const picRef = this.storage.ref(`${this.auth.currentUser.uid}/full/${newPostKey}/${fileName}`);\n    const metadata = {\n      contentType: pic.type\n    };\n    var picUploadTask = picRef.put(pic, metadata).then(snapshot => {\n      console.log('New pic uploaded. Size:', snapshot.totalBytes, 'bytes.');\n      var url = snapshot.metadata.downloadURLs[0];\n      console.log('File available at', url);\n      return url;\n    }).catch(error => {\n      console.error('Error while uploading new pic', error);\n    });\n\n    // Start the thumb file upload to Cloud Storage.\n    const thumbRef = this.storage.ref(`${this.auth.currentUser.uid}/thumb/${newPostKey}/${fileName}`);\n    var tumbUploadTask = thumbRef.put(thumb, metadata).then(snapshot => {\n      console.log('New thumb uploaded. Size:', snapshot.totalBytes, 'bytes.');\n      var url = snapshot.metadata.downloadURLs[0];\n      console.log('File available at', url);\n      return url;\n    }).catch(error => {\n      console.error('Error while uploading new thumb', error);\n    });\n\n    return Promise.all([picUploadTask, tumbUploadTask]).then(urls => {\n      // Once both pics and thumbnails has been uploaded add a new post in the Firebase Database and\n      // to its fanned out posts lists (user's posts and home post).\n      const update = {};\n      update[`/posts/${newPostKey}`] = {\n        full_url: urls[0],\n        thumb_url: urls[1],\n        text: text,\n        timestamp: firebase.database.ServerValue.TIMESTAMP,\n        full_storage_uri: picRef.toString(),\n        thumb_storage_uri: thumbRef.toString(),\n        author: {\n          uid: this.auth.currentUser.uid,\n          full_name: this.auth.currentUser.displayName,\n          profile_picture: this.auth.currentUser.photoURL\n        }\n      };\n      update[`/people/${this.auth.currentUser.uid}/posts/${newPostKey}`] = true;\n      update[`/feed/${this.auth.currentUser.uid}/${newPostKey}`] = true;\n      return this.database.ref().update(update).then(() => newPostKey);\n    });\n  }\n\n  /**\n   * Follow/Unfollow a user and return a promise once that's done.\n   *\n   * If the user is now followed we'll add all his posts to the home feed of the follower.\n   * If the user is now not followed anymore all his posts are removed from the follower home feed.\n   */\n  toggleFollowUser(followedUserId, follow) {\n    // Add or remove posts to the user's home feed.\n    return this.database.ref(`/people/${followedUserId}/posts`).once('value').then(\n        data => {\n          const updateData = {};\n          let lastPostId = true;\n\n          // Add followed user's posts to the home feed.\n          data.forEach(post => {\n            updateData[`/feed/${this.auth.currentUser.uid}/${post.key}`] = follow ? !!follow : null;\n            lastPostId = post.key;\n          });\n\n          // Add followed user to the 'following' list.\n          updateData[`/people/${this.auth.currentUser.uid}/following/${followedUserId}`] =\n              follow ? lastPostId : null;\n\n          // Add signed-in suer to the list of followers.\n          updateData[`/followers/${followedUserId}/${this.auth.currentUser.uid}`] =\n              follow ? !!follow : null;\n          return this.database.ref().update(updateData);\n        });\n  }\n\n  /**\n   * Listens to updates on the followed status of the given user.\n   */\n  registerToFollowStatusUpdate(userId, callback) {\n    const followStatusRef =\n        this.database.ref(`/people/${this.auth.currentUser.uid}/following/${userId}`);\n    followStatusRef.on('value', callback);\n    this.firebaseRefs.push(followStatusRef);\n  }\n\n  /**\n   * Enables or disables the notifications for that user.\n   */\n  toggleNotificationEnabled(checked) {\n    return this.database.ref(`/people/${this.auth.currentUser.uid}/notificationEnabled`)\n        .set(checked ? checked : null);\n  }\n\n  /**\n   * Saves the given notification token.\n   */\n  saveNotificationToken(token) {\n    return this.database.ref(`/people/${this.auth.currentUser.uid}/notificationTokens/${token}`)\n        .set(true);\n  }\n\n  /**\n   * Listens to updates on the Enable notifications status of the current user.\n   */\n  registerToNotificationEnabledStatusUpdate(callback) {\n    const followStatusRef =\n        this.database.ref(`/people/${this.auth.currentUser.uid}/notificationEnabled`);\n    followStatusRef.on('value', callback);\n    this.firebaseRefs.push(followStatusRef);\n  }\n\n  /**\n   * Load a single user profile information\n   */\n  loadUserProfile(uid) {\n    return this.database.ref(`/people/${uid}`).once('value');\n  }\n\n  /**\n   * Listens to updates on the likes of a post and calls the callback with likes counts.\n   * TODO: This won't scale if a user has a huge amount of likes. We need to keep track of a\n   *       likes count instead.\n   */\n  registerForLikesCount(postId, likesCallback) {\n    const likesRef = this.database.ref(`/likes/${postId}`);\n    likesRef.on('value', data => likesCallback(data.numChildren()));\n    this.firebaseRefs.push(likesRef);\n  }\n\n  /**\n   * Listens to updates on the comments of a post and calls the callback with comments counts.\n   */\n  registerForCommentsCount(postId, commentsCallback) {\n    const commentsRef = this.database.ref(`/comments/${postId}`);\n    commentsRef.on('value', data => commentsCallback(data.numChildren()));\n    this.firebaseRefs.push(commentsRef);\n  }\n\n  /**\n   * Listens to updates on the followers of a person and calls the callback with followers counts.\n   * TODO: This won't scale if a user has a huge amount of followers. We need to keep track of a\n   *       follower count instead.\n   */\n  registerForFollowersCount(uid, followersCallback) {\n    const followersRef = this.database.ref(`/followers/${uid}`);\n    followersRef.on('value', data => followersCallback(data.numChildren()));\n    this.firebaseRefs.push(followersRef);\n  }\n\n  /**\n   * Listens to updates on the followed people of a person and calls the callback with its count.\n   */\n  registerForFollowingCount(uid, followingCallback) {\n    const followingRef = this.database.ref(`/people/${uid}/following`);\n    followingRef.on('value', data => followingCallback(data.numChildren()));\n    this.firebaseRefs.push(followingRef);\n  }\n\n  /**\n   * Listens for changes of the thumbnail URL of a given post.\n   */\n  registerForThumbChanges(postId, callback) {\n    const thumbRef = this.database.ref(`/posts/${postId}/thumb_url`);\n    thumbRef.on('value', data => callback(data.val()));\n    this.firebaseRefs.push(thumbRef);\n  }\n\n  /**\n   * Fetch the list of followed people's profile.\n   */\n  getFollowingProfiles(uid) {\n    return this.database.ref(`/people/${uid}/following`).once('value').then(data => {\n      if (data.val()) {\n        const followingUids = Object.keys(data.val());\n        const fetchProfileDetailsOperations = followingUids.map(\n          followingUid => this.loadUserProfile(followingUid));\n        return Promise.all(fetchProfileDetailsOperations).then(results => {\n          const profiles = {};\n          results.forEach(result => {\n            if (result.val()) {\n              profiles[result.key] = result.val();\n            }\n          });\n          return profiles;\n        });\n      }\n      return {};\n    });\n  }\n\n  /**\n   * Listens to updates on the user's posts and calls the callback with user posts counts.\n   */\n  registerForPostsCount(uid, postsCallback) {\n    const userPostsRef = this.database.ref(`/people/${uid}/posts`);\n    userPostsRef.on('value', data => postsCallback(data.numChildren()));\n    this.firebaseRefs.push(userPostsRef);\n  }\n\n  /**\n   * Deletes the given post from the global post feed and the user's post feed. Also deletes\n   * comments, likes and the file on Cloud Storage.\n   */\n  deletePost(postId, picStorageUri, thumbStorageUri) {\n    console.log(`Deleting ${postId}`);\n    const updateObj = {};\n    updateObj[`/people/${this.auth.currentUser.uid}/posts/${postId}`] = null;\n    updateObj[`/comments/${postId}`] = null;\n    updateObj[`/likes/${postId}`] = null;\n    updateObj[`/posts/${postId}`] = null;\n    updateObj[`/feed/${this.auth.currentUser.uid}/${postId}`] = null;\n    const deleteFromDatabase = this.database.ref().update(updateObj);\n    if (picStorageUri) {\n      const deletePicFromStorage = this.storage.refFromURL(picStorageUri).delete();\n      const deleteThumbFromStorage = this.storage.refFromURL(thumbStorageUri).delete();\n      return Promise.all([deleteFromDatabase, deletePicFromStorage, deleteThumbFromStorage]);\n    }\n    return deleteFromDatabase;\n  }\n\n  /**\n   * Deletes the given postId entry from the user's home feed.\n   */\n  deleteFromFeed(uri, postId) {\n    return this.database.ref(`${uri}/${postId}`).remove();\n  }\n\n  /**\n   * Listens to deletions on posts from the global feed.\n   */\n  registerForPostsDeletion(deletionCallback) {\n    const postsRef = this.database.ref(`/posts`);\n    postsRef.on('child_removed', data => deletionCallback(data.key));\n    this.firebaseRefs.push(postsRef);\n  }\n};\n\nfriendlyPix.firebase = new friendlyPix.Firebase();\n"]}